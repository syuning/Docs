<div class="page-title">
  <div class="page-title-opt pull-right">

    <button nz-button (click)="createAutoClnJobModal()" [disabled]="detail.status != 'RUNNING'">数据时效</button>

  <nzi-modal [(nzVisible)]="isAutoModalVisible" [nzTitle]="autoTitle" [nzContent]="autoContent" [nzFooter]="autoFooter" (nzOnCancel)="handleAutoClnJobModalCancel()">
  <ng-template #autoTitle><span>数据时效</span></ng-template>
  <ng-template #autoContent>
      <nz-alert nzType="warning" [nzMessage]="innerTemplate" nzShowIcon [ngStyle]="{ 'marginBottom': '16px' }">
          <ng-template #innerTemplate>
              温馨提示：启用数据时效功能，系统将自动删除时效范围之外的数据。
          </ng-template>
        </nz-alert>
    <nzi-form [formName]="autoClnJobForm">
        <form nz-form [formGroup]="autoClnJobForm">
            <nz-form-item>
                <nz-form-label>数据时效</nz-form-label>
                <nz-form-control>
                  <nz-radio-group [nzButtonStyle]="'solid'" >
                      <nz-switch formControlName="autoClnSwitch" id="autoClnSwitch" nzCheckedChildren="开启" nzUnCheckedChildren="关闭"></nz-switch>
                  </nz-radio-group>
                </nz-form-control>
              </nz-form-item>

              <nz-form-item *ngIf="autoClnJobForm.get('autoClnSwitch').value">
                  <nz-form-label>度量</nz-form-label>
                  <nz-form-control>
                      全部度量
                  </nz-form-control>
                </nz-form-item>

                <nz-form-item *ngIf="autoClnJobForm.get('autoClnSwitch').value">
                <nz-form-label>时效范围<span class="required-icon">*</span></nz-form-label>
                <nz-form-control>
                   保留最近
                   <input nz-input formControlName="retain" style="width: 60px; margin-left: 5px; margin-right: 5px" nzSize="small">
                   天以内的数据。
                  <nz-form-explain *ngIf="autoClnJobForm.get('retain').dirty && autoClnJobForm.get('retain').invalid">保留天数必须是正整数</nz-form-explain>
                  <p class="help-text" *ngIf="!autoClnJobForm.get('retain').dirty || autoClnJobForm.get('retain').valid" style="margin-left: 0px">保留天数必须是正整数</p>
                </nz-form-control>
              </nz-form-item>

        </form>
    </nzi-form>
  </ng-template>
  <ng-template #autoFooter>
    <button nz-button nzType="primary" (click)="handleAutoClnJobModalOk()" [nzLoading]="isAutoModalConfirmLoading">确定</button>
    <button nz-button nzType="info" (click)="handleAutoClnJobModalCancel()">取消</button>
  </ng-template>
</nzi-modal>

    <button nz-button (click)="addClnJobModal()" [disabled]="detail.status != 'RUNNING'">清理数据</button>

    <button *ngIf="detail.billMode === 'hourlySettlement'" nz-button (click)="showDeleteTsdbModal(detail)" [disabled]="detail.status != 'RUNNING'">删除</button>

    <button nz-button  nz-popover [nzContent]="'刷新'" (click)="refresh()" [disabled]="detail.status != 'RUNNING'"><i class="anticon anticon-reload"></i></button>

  </div>

  <nz-breadcrumb>
    <div class="light"></div>
    <div class="dark"></div>
    <nz-breadcrumb-item>
      <a [routerLink]="['/tsdb/list']">时序数据库</a>
    </nz-breadcrumb-item>
    <nz-breadcrumb-item>
      {{detail.name}}
    </nz-breadcrumb-item>
  </nz-breadcrumb>

</div>

<nz-spin [nzSpinning]="loading">
  <nz-tabset class="tab-top-border" [nzSelectedIndex]="tabIndex">
    <nz-tab nzTitle="概况">
      <div class="row">
        <div class="col-sm-6">
          <div class="form-fieldset form-horizontal form-align-left">
            <fieldset>
              <legend>
                基本信息
              </legend>
              <div class="form-static">
                <div class="form-group">
                  <label class="control-label col-em-6">ID：</label>
                  <div class="col-em-offset-6">
                    <p class="form-control-static">{{detail.id}}</p>
                  </div>
                </div>
                <div class="form-group">
                  <label class="control-label col-em-6">名称：</label>
                  <div class="col-em-offset-6">
                    <p class="form-control-static operational"><span>{{detail.name}}</span>
                      <i class="anticon anticon-edit" nz-popover nzTrigger="click" [nzVisible]="editable"
                        [nzContent]="contentTemplate" (click)="editable=true" (nzVisibleChange)="visibleChange()">
                      </i>
                      <ng-template #contentTemplate>
                        <div class="td-opt-content clearfix">
                          <div [class.has-error]="hasError">
                            <input nz-input [ngModel]="tsdbName" (ngModelChange)="modelChange($event)">
                            <div *ngIf="hasError && error?.required" class="ant-form-explain">该内容不可为空</div>
                            <div *ngIf="hasError && error?.patten" class="ant-form-explain">内容或长度不符合要求</div>
                            <div *ngIf="hasError && error?.noChange" class="ant-form-explain">没有发生修改</div>
                            <div class="help-text">长度2-128字符，不能以特殊字符和数字开头，只可包含特殊字符中的"."，"_"，"-"</div>
                          </div>
                          <div class="pull-right">
                            <button nz-button nzType="primary" (click)="submit(tsdbName)"><i
                                class="anticon anticon-check"></i></button>
                            <button nz-button nzType="default" (click)="editable=false"><i
                                class="anticon anticon-close"></i></button>
                          </div>
                        </div>
                      </ng-template>
                    </p>
                  </div>
                </div>
                <div class="form-group">
                  <label class="control-label col-em-6">状态：</label>
                  <div class="col-em-offset-6">
                    <p class="form-control-static" [innerHtml]="detail.status | status: 'tsdbstatus' | async"></p>
                  </div>
                </div>
                <!-- <div class="form-group">
                  <label class="control-label col-em-6">访问域名：</label>
                  <div class="col-em-offset-6">
                    <p class="form-control-static">{{detail.domain}}</p>
                  </div>
                </div> -->
                <div class="form-group">
                  <label class="control-label col-em-6">HTTP URL：</label>
                  <div class="col-em-offset-6">
                    <p class="form-control-static">{{detail.serviceUrl}}</p>
                  </div>
                </div>
                <div class="form-group">
                  <label class="control-label col-em-6">运行时间：</label>
                  <div class="col-em-offset-6">
                    <!-- <p class="form-control-static">{{runningTime | number:"0.1-2"}} 天</p> -->
                    <p class="form-control-static">{{runningTime}}</p>
                  </div>
                </div>
                <div class="form-group">
                  <label class="control-label col-em-6">计费模式：</label>
                  <div class="col-em-offset-6">
                    <p class="form-control-static">{{ detail.billMode | dict: "assets/status/billMode.json":"mode":"label":true | async }}</p>
                  </div>
                </div>
                <div class="form-group">
                  <label class="control-label col-em-6">创建时间：</label>
                  <div class="col-em-offset-6">
                    <p class="form-control-static">{{detail.createTime|date:'y-MM-dd HH:mm:ss'}}</p>
                  </div>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
        <div class="col-sm-6">
          <div style="height: 305px;" class="form-fieldset form-horizontal form-align-left">
            <fieldset>
              <legend>
                规格
              </legend>
              <div class="form-static">
                <div class="form-group">
                  <label class="control-label col-em-7">实例规格：</label>
                  <div class="col-em-offset-7">
                    <p class="form-control-static">{{detail.spec || '通用型'}}</p>
                  </div>
                </div>

                <div class="form-group">
                  <label class="control-label col-em-7">写入能力：</label>
                  <div class="col-em-offset-7">
                    <p class="form-control-static">{{detail.wrtDpPers}}&nbsp;&nbsp;数据点/秒</p>
                  </div>
                </div>
                <div class="form-group">
                  <label class="control-label col-em-7">时间序列：</label>
                  <div class="col-em-offset-7">
                    <p class="form-control-static">{{detail.maxDpNum | number:"1.0-0"}}</p>
                  </div>
                </div>
                <div class="form-group">
                  <label class="control-label col-em-7">存储空间：</label>
                  <div class="col-em-offset-7">
                    <p class="form-control-static">{{detail.storageSize}}&nbsp;&nbsp;GB</p>
                  </div>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
      </div>
    </nz-tab>
    <nz-tab nzTitle="数据查询">
      <app-query-panel *ngIf="detail.status=='RUNNING'"></app-query-panel>
    </nz-tab>
    <nz-tab nzTitle="实例监控">
      <app-tsdb-monitor *ngIf="detail.status=='RUNNING'"></app-tsdb-monitor>
    </nz-tab>
    <nz-tab nzTitle="数据清理">
      <app-cln-job [tsdbId]="tsdbId" *ngIf="detail.status=='RUNNING'"></app-cln-job>
    </nz-tab>
    <nz-tab nzTitle="导入导出">
      <app-tsdb-ie-data *ngIf="detail.status=='RUNNING'"></app-tsdb-ie-data>
    </nz-tab>
    <nz-tab nzTitle="用户管理">
      <app-user *ngIf="detail.status=='RUNNING'"></app-user>
    </nz-tab>
  </nz-tabset>
</nz-spin>
