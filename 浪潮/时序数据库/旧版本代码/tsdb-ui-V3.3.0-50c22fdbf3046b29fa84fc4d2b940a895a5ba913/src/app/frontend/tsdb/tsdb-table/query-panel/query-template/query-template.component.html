<div class="table-top table-operations clearfix">
  <div class="pull-left">
    <app-template-add #createTemplateModal (updateTemplateList)="getTemplateList()"></app-template-add>
    <button nz-button (click)="createTemplateModal.showCreatingModal()" nzType="primary" class="btn-add" style="margin-top: -1px;"><i
        class="fas fa-plus"></i>
      新建模板</button>
  </div>
</div>

<!-- <div class="form-fieldset form-horizontal form-align-left">
  <div>
    <legend>
      <i class="icon-square"></i>
      查询模板列表：
    </legend>
  </div> -->
  <nz-table #nestedTableTemplates [nzShowSizeChanger]="true" [nzData]="templates" [nzLoading]="loading" nzBordered="true">
    <thead>
      <tr>
        <!-- <th nzShowExpand>标签</th> -->
        <th>模板名称</th>
        <th>指标名称</th>
        <th>聚合函数</th>
        <th>插值</th>
        <th>采样间隔</th>
        <th>创建时间</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <ng-template ngFor let-data [ngForOf]="nestedTableTemplates.data">
        <tr>
          <!-- <td nzShowExpand [(nzExpand)]="data.expand"></td> -->
          <td>{{data.name}}</td>
          <td>{{data.metric}}</td>
          <td>
            {{data.down_sampling.agg_func}}
            <!-- <nz-divider nzType="horizontal"></nz-divider> -->
          </td>
          <td>{{data.down_sampling.interpolation}} </td>
          <td>{{data.down_sampling.sample_interval.value}}{{data.down_sampling.sample_interval.unit}}</td>
          <td> {{data.create_time|date:'y-MM-dd HH:mm:ss'}} </td>
          <td>
            <a (click)="showEditTemplateModal(data)">编辑</a>
            <nz-divider nzType="vertical"></nz-divider>
            <nz-popconfirm [nzTitle]="'确认删除ID为 ' + data.id + '的模板?'" (nzOnConfirm)="removeTemplate(data.id)">
              <a nz-popconfirm>删除</a>
            </nz-popconfirm>
          </td>
        </tr>
        <!-- <tr [nzExpand]="data.expand">
          <td></td>
          <td colspan="4"> ------一些其他的东西------ </td>
        </tr> -->
        <!-- <tr [nzExpand]="data.expand">
          <td></td>
          <td colspan="7">
            <nz-table #innerTableTemplates [nzData]="data.tag_filters" nzSize="middle" [nzShowPagination]="false">
              <thead>
                <tr>
                  <th>标签索引</th>
                  <th>是否分组</th>
                  <th>标签名称</th>
                  <th>标签类型</th>
                  <th>标签值</th>
                </tr>
              </thead>
    <tbody>
      <tr *ngFor="let data of innerTableTemplates.data; let i = index">
        <td> {{i}} </td>
        <td>{{data.isGroupBy}}</td>
        <td>{{data.name}}</td>
        <td>{{data.type}}</td>
        <td>{{data.value}}</td>
      </tr>
    </tbody>
  </nz-table>
  </td>
  </tr> -->
  </ng-template>
  </tbody>
  </nz-table>
<!-- </div> -->

<nz-modal [(nzVisible)]="isEditTemplateModalVisible" [nzTitle]="modalTitle" [nzContent]="modalContent" [nzFooter]="modalFooter"
  (nzOnCancel)="handleEditTemplateModalCancel()">
  <ng-template #modalTitle>
    编辑模板
  </ng-template>

  <ng-template #modalContent>
    <form nz-form [formGroup]="editTemplateForm" (ngSubmit)="submitEditTemplateForm($event,editTemplateForm.value)">
      <nz-form-item>
        <nz-form-label nzRequired nzFor="templateName">模板名称<span class="required-icon">*</span></nz-form-label>
        <nz-form-control>
          <input formControlName="templateName" class="form-input" width="100%" placeHolder="请输入模板名称" nz-input>
          <nz-form-explain *ngIf="editTemplateForm.get('templateName').dirty && editTemplateForm.get('templateName').invalid || editTemplateForm.get('templateName').pending ">
            <ng-container *ngIf="editTemplateForm.get('templateName').hasError('required')">
              请输入模板名称！
            </ng-container>
            <ng-container *ngIf="editTemplateForm.get('templateName').invalid">
              模板名称的长度为2-128个字符，只能以字母或汉字开头，并且仅包含字母、汉字、数字、”.“、”_“或”-“！
            </ng-container>
            <ng-container *ngIf="editTemplateForm.get('templateName').pending">
              验证中...
            </ng-container>
          </nz-form-explain>
        </nz-form-control>
      </nz-form-item>

      <nz-divider></nz-divider>

      <nz-form-item>
        <nz-form-label nzRequired>标签</nz-form-label>
        <nz-form-control>
          <ng-container *ngFor="let tagFilter of tagFiltersToBeEdited; let i = index">
            <div class="input-number-container">
              <span nz-checkbox [formControlName]="i+'_isGroupBy'"><label>分组</label></span>
              <div class="sys-form">
                <nz-select style="padding-top:5px;width: 140px;margin-right: 10px;" [formControlName]="i+'_type'" nzPlaceHolder="请选择标签类型">
                  <nz-option *ngFor="let option of filterTypes" [nzLabel]="option.label" [nzValue]="option.value"></nz-option>
                </nz-select>
                <input style="padding-top:5px;width: 100px;margin-right: 10px;" [formControlName]="i+'_name'" placeHolder="标签名称" nz-input>
                <input style="padding-top:5px;width: 100px;margin-right: 10px;" [formControlName]="i+'_value'" placeHolder="标签值" nz-input>
                <!-- <i class="anticon anticon-close-circle-o" (click)="removeTagFilter(tagFilter,$event)"></i> -->
              </div>
            </div>
          </ng-container>
        </nz-form-control>
      </nz-form-item>

      <nz-divider></nz-divider>

      <nz-form-item>
        <nz-form-label nzRequired nzFor="metricName">指标名称<span class="required-icon">*</span></nz-form-label>
        <nz-form-control>
          <input formControlName="metricName" class="form-input" width="100%" placeHolder="请输入指标名称" nz-input>
          <nz-form-explain *ngIf="editTemplateForm.get('metricName').dirty && editTemplateForm.get('metricName').invalid || editTemplateForm.get('metricName').pending ">
            <ng-container *ngIf="editTemplateForm.get('metricName').hasError('required')">
              请输入指标名称！
            </ng-container>
            <ng-container *ngIf="editTemplateForm.get('metricName').hasError('invalid')">
              指标名称的长度应为2-50，并且只能由小写字母、数字或符号“.”组成!
            </ng-container>
            <ng-container *ngIf="editTemplateForm.get('metricName').pending">
              验证中...
            </ng-container>
          </nz-form-explain>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired>聚合函数<span class="required-icon">*</span></nz-form-label>
        <nz-form-control>
          <nz-select formControlName="aggFun" placeHolder="请选择">
            <nz-option *ngFor="let option of aggFuns" [nzLabel]="option.label" [nzValue]="option.value"></nz-option>
          </nz-select>
          <nz-form-explain *ngIf="editTemplateForm.get('aggFun').dirty && editTemplateForm.get('aggFun').errors">请选择聚合函数！</nz-form-explain>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired>插值<span class="required-icon">*</span></nz-form-label>
        <nz-form-control>
          <nz-select formControlName="interpolation" nzPlaceHolder="请选择">
            <nz-option *ngFor="let option of interpolations" [nzLabel]="option.label" [nzValue]="option.value"></nz-option>
          </nz-select>
          <nz-form-explain *ngIf="editTemplateForm.get('interpolation').dirty && editTemplateForm.get('interpolation').errors">请选择插值！</nz-form-explain>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired>采样间隔<span class="required-icon">*</span></nz-form-label>
        <nz-form-control>
          <nz-input-number formControlName="sampleTime" [nzMin]="1" [nzStep]="1"></nz-input-number>
          <nz-form-explain *ngIf="editTemplateForm.get('sampleTime').dirty && editTemplateForm.get('sampleTime').errors">请输入采样间隔！</nz-form-explain>
          <nz-select style="width: 35%;" formControlName="sampleTimeUnit" nzPlaceHolder="请选择">
            <nz-option *ngFor="let option of timeUnitOptions" [nzLabel]="option.label" [nzValue]="option.value"></nz-option>
          </nz-select>
          <nz-form-explain *ngIf="editTemplateForm.get('sampleTimeUnit').dirty && editTemplateForm.get('sampleTimeUnit').errors">请选择采样单位！</nz-form-explain>
          <nzi-help [options]="{'title': '<p>选择降采样的聚合函数和插值算法</p><p>插值算法：</p><p>None–在序列化过程中不会发出缺失值，
                            并在聚合序列时执行线性插值（或其他指定的插值）。</p><p>NaN–当序列中所有值都缺失时，在序列化输出中发出NaN。</p><p>Null–除了在序
                            列化过程中它发出的是一个null而不是NaN，与NaN有相同的行为。</p><p>Zero–当缺少时间戳时以0替换。零值将被合并到聚合结果中。</p>'}">
          </nzi-help>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-template>

  <ng-template #modalFooter>
    <button nz-button nzType="default" (click)="handleEditTemplateModalCancel()">取消</button>
    <button nz-button nzType="primary" (click)="editTemplate(editTemplateForm.get('templateId').value)"
      [nzLoading]="isEditTemplateConfirmLoading">确认</button>
  </ng-template>
</nz-modal>
