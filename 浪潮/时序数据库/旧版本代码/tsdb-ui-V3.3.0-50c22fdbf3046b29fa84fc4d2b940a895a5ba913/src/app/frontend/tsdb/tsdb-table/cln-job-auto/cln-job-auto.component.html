<div class="page-title">
  <!-- <nzi-breadcrumb detailName="自动数据清理"></nzi-breadcrumb> -->
  <nz-breadcrumb>
    <div class="light"></div><div class="dark"></div>
    <nz-breadcrumb-item><a [routerLink]="['/tsdb/list']">时序数据库</a></nz-breadcrumb-item>
    <nz-breadcrumb-item>自动数据清理</nz-breadcrumb-item>
  </nz-breadcrumb>
</div>

<form nz-form [formGroup]="clnJobForm" (ngSubmit)="submitclnJobForm()">
  <nz-form-item>
    <nz-form-label [nzSpan]="5" nzRequired nzFor="jobName">任务名称</nz-form-label>
    <nz-form-control [nzSpan]="12">
      <input id="jobName" type="text" nz-input formControlName="jobName">
      <!-- <nz-form-explain *ngIf="clnJobForm.get('jobName').dirty && clnJobForm.get('jobName').errors">请输入任务名称！</nz-form-explain> -->
      <nz-form-explain *ngIf="clnJobForm.get('jobName').dirty && clnJobForm.get('jobName').invalid || clnJobForm.get('jobName').pending ">
        <ng-container *ngIf="clnJobForm.get('jobName').hasError('required')">
          请输入任务名称！
        </ng-container>
        <ng-container *ngIf="clnJobForm.get('jobName').invalid">
          任务名称的长度为2-128个字符，只能以字母或汉字开头，并且仅包含字母、汉字、数字、”.“、”_“或”-“！
        </ng-container>
        <ng-container *ngIf="clnJobForm.get('jobName').pending">
          验证中...
        </ng-container>
      </nz-form-explain>
    </nz-form-control>
  </nz-form-item>

  <nz-divider></nz-divider>

  <!-- 自动清理任务时间设置 -->
  <nz-form-item>
    <nz-form-label [nzSm]="8" [nzXs]="24" nzRequired>时间单位</nz-form-label>
    <nz-form-control [nzSm]="16" [nzXs]="24">
      <nz-radio-group id="timeUnit" formControlName="timeUnit" [nzButtonStyle]="'solid'">
        <label nz-radio-button nzValue="MONTH">月</label>
        <label nz-radio-button nzValue="DAY">日</label>
        <label nz-radio-button nzValue="HOUR">小时</label>
      </nz-radio-group>
    </nz-form-control>
  </nz-form-item>

  <nz-form-item>
    <nz-form-label [nzSpan]="5" nzRequired nzFor="retain">保留时间</nz-form-label>
    <nz-form-control [nzSpan]="12">
      <input id="retain" type="text" nz-input formControlName="retain">
      <nz-form-explain *ngIf="clnJobForm.get('retain').dirty && clnJobForm.get('retain').invalid || clnJobForm.get('retain').pending ">
        <ng-container *ngIf="clnJobForm.get('retain').hasError('required')">
          请输入保留时间！
        </ng-container>
        <ng-container *ngIf="clnJobForm.get('retain').hasError('invalid')">
          输入的保留时间必须是非零的正整数!
        </ng-container>
        <ng-container *ngIf="clnJobForm.get('retain').pending">
          验证中...
        </ng-container>
      </nz-form-explain>
    </nz-form-control>
  </nz-form-item>

  <nz-form-item>
    <nz-form-label [nzSpan]="5" nzRequired nzFor="cronExpression">触发周期</nz-form-label>
    <nz-form-control [nzSpan]="12">
      <input id="cronExpression" type="text" nz-input formControlName="cronExpression">
      <nz-form-explain *ngIf="clnJobForm.get('cronExpression').dirty && clnJobForm.get('cronExpression').invalid || clnJobForm.get('cronExpression').pending ">
        <ng-container *ngIf="clnJobForm.get('cronExpression').hasError('required')">
          请输入触发周期！
        </ng-container>
        <ng-container *ngIf="clnJobForm.get('cronExpression').hasError('invalid')">
          输入的触发周期无效!
        </ng-container>
        <ng-container *ngIf="clnJobForm.get('cronExpression').pending">
          验证中...
        </ng-container>
      </nz-form-explain>
    </nz-form-control>
  </nz-form-item>

  <nz-divider></nz-divider>

  <nz-form-item>
    <nz-form-label [nzSpan]="5" nzRequired nzFor="metricName">指标名称</nz-form-label>
    <nz-form-control [nzSpan]="12">
      <input id="metricName" type="text" nz-input formControlName="metricName">
      <!-- <nz-form-explain *ngIf="clnJobForm.get('metricName').dirty && clnJobForm.get('metricName').errors">请输入指标名称！</nz-form-explain> -->
      <nz-form-explain *ngIf="clnJobForm.get('metricName').dirty && clnJobForm.get('metricName').invalid || clnJobForm.get('metricName').pending ">
        <ng-container *ngIf="clnJobForm.get('metricName').hasError('required')">
          请输入指标名称！
        </ng-container>
        <ng-container *ngIf="clnJobForm.get('metricName').hasError('invalid')">
          指标名称的长度不能超过50!
        </ng-container>
        <ng-container *ngIf="clnJobForm.get('metricName').pending">
          验证中...
        </ng-container>
      </nz-form-explain>
    </nz-form-control>
  </nz-form-item>

  <nz-form-item>
    <nz-form-label nzRequired nzFor="tag_filters">标签</nz-form-label>
    <nz-form-control>
      <ng-container *ngFor="let tagFilter of tagFilters, let i = index">
        <div class="input-number-container">
          <div class="sys-form">
            <label nz-checkbox [formControlName]="i+'_isGroupBy'">分组</label>
            <nz-select style="padding-right:0px; padding-top:5px;width: 100px;" [formControlName]="i+'_type'"
              nzPlaceHolder="请选择">
              <nz-option *ngFor="let option of filterTypes" [nzLabel]="option.label" [nzValue]="option.value"></nz-option>
            </nz-select>
            <input style="padding-right:0px; padding-top:5px;width: 100px;margin-left: 20px;" [formControlName]="i+'_name'"
              placeHolder="标签名称" nz-input>
            <input style="margin-right:5px; padding-top:5px;width: 100px;margin-left: 20px;" [formControlName]="i+'_value'"
              placeHolder="标签值" nz-input>
            <i class="anticon anticon-close-circle-o" (click)="removeTagFilter(tagFilter,$event)"></i>
          </div>
        </div>
      </ng-container>
      <div class="add-action">
        <i class="anticon anticon-plus-square" (click)="addTagFilter($event)"></i>
        添加标签过滤
        <nzi-help [options]="{'title': '<p>分组是否根据tagV进行分组</p><p>选择过滤器的类型</p><p>输入标签名称tagK</p><p>输入标签值tagV(表达式)</p>'}">
        </nzi-help>
      </div>
    </nz-form-control>
  </nz-form-item>

  <nz-form-item>
    <nz-form-control>
      <nz-spin [nzSpinning]="isButtonLoading">
      <button nz-button nzType="primary" (click)="createJob()"  [disabled]="!clnJobForm.valid">创建任务</button>
      </nz-spin>
    </nz-form-control>
  </nz-form-item>
</form>

<nz-divider></nz-divider>

  <nz-table #nestedTableAutoJobs [nzData]="cleanJobsAuto" [nzLoading]="loading" [nzShowSizeChanger]="true" nzBordered>
    <thead>
      <tr>
        <th>任务名称</th>
        <th>保留时间</th>
        <th>触发机制</th>
        <th>指标名称</th>
        <th>创建时间</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <ng-template ngFor let-data [ngForOf]="nestedTableAutoJobs.data" let-jobIndex="index">
        <tr>
          <td>{{data.clnJobName}}</td>
          <td>{{data.retain}} {{data.timeUnit}}</td>
          <td>{{data.cronExpression}}</td>
          <td *ngFor="let metric of getMetric(data.metrics)">
            {{metric.metric}}
          </td>
          <td>{{data.createTime | date:'y-MM-dd HH:mm:ss' }}</td>
          <td>
            <!-- <a (click)="showTerminatingModal()">终止作业</a> -->
            <a (click)="showEditingModal(data)">编辑</a>
            <nz-divider nzType="vertical"></nz-divider>
            <a (click)="showJobDeleteConfirm(data.clnJobName)">删除</a>
          </td>
        </tr>
      </ng-template>
    </tbody>
  </nz-table>

<nz-modal [(nzVisible)]="isEditingModalVisible" [nzTitle]="editingModalTitle" [nzContent]="editingModalContent"
  [nzFooter]="editinggModalFooter" (nzOnCancel)="handleEditingModalCancel()">
  <ng-template #editingModalTitle>
    编辑任务
  </ng-template>

  <ng-template #editingModalContent>
    <form nz-form [formGroup]="clnJobEditForm" (ngSubmit)="submitclnJobForm()">

      <nz-form-item>
        <nz-form-label [nzSpan]="5" nzRequired nzFor="jobName">任务名称</nz-form-label>
        <nz-form-control [nzSpan]="12">
          <input nz-input formControlName="jobName">
          <nz-form-explain *ngIf="clnJobEditForm.get('jobName').dirty && clnJobEditForm.get('jobName').errors">请输入任务名称！</nz-form-explain>
        </nz-form-control>
      </nz-form-item>

      <nz-divider></nz-divider>

      <!-- 自动清理任务时间设置 -->
      <nz-form-item>
        <nz-form-label [nzSm]="8" [nzXs]="24" nzRequired>时间单位</nz-form-label>
        <nz-form-control [nzSm]="16" [nzXs]="24">
          <nz-radio-group id="timeUnit" formControlName="timeUnit" [nzButtonStyle]="'solid'">
            <label nz-radio-button nzValue="MONTH">月</label>
            <label nz-radio-button nzValue="DAY">日</label>
            <label nz-radio-button nzValue="HOUR">小时</label>
          </nz-radio-group>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="5" nzRequired nzFor="retain">保留时间</nz-form-label>
        <nz-form-control [nzSpan]="12">
          <input id="retain" type="text" nz-input formControlName="retain">
          <!-- <nz-form-explain *ngIf="clnJobEditForm.get('retain').dirty && clnJobEditForm.get('retain').errors">请输入保留时间！</nz-form-explain> -->
          <nz-form-explain *ngIf="clnJobEditForm.get('retain').dirty && clnJobEditForm.get('retain').errors || clnJobEditForm.get('retain').pending ">
            <ng-container *ngIf="clnJobEditForm.get('retain').hasError('required')">
              请输入保留时间！
            </ng-container>
            <ng-container *ngIf="clnJobEditForm.get('retain').dirty && clnJobEditForm.get('retain').errors">
              输入的保留时间必须是非零的正整数!
            </ng-container>
            <ng-container *ngIf="clnJobEditForm.get('retain').pending">
              验证中...
            </ng-container>
          </nz-form-explain>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="5" nzRequired nzFor="cronExpression">触发周期</nz-form-label>
        <nz-form-control [nzSpan]="12">
          <input id="cronExpression" type="text" nz-input formControlName="cronExpression">
          <!-- <nz-form-explain *ngIf="clnJobEditForm.get('cronExpression').dirty && clnJobEditForm.get('cronExpression').errors">请输入触发周期！</nz-form-explain> -->
          <nz-form-explain *ngIf="clnJobEditForm.get('cronExpression').dirty && clnJobEditForm.get('cronExpression').invalid || clnJobEditForm.get('cronExpression').pending ">
            <ng-container *ngIf="clnJobEditForm.get('cronExpression').hasError('required')">
              请输入触发周期！
            </ng-container>
            <ng-container *ngIf="clnJobEditForm.get('cronExpression').hasError('invalid')">
              输入的触发周期无效!
            </ng-container>
            <ng-container *ngIf="clnJobEditForm.get('cronExpression').pending">
              验证中...
            </ng-container>
          </nz-form-explain>
        </nz-form-control>
        <nz-divider></nz-divider>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="5" nzRequired nzFor="metricName">指标名称</nz-form-label>
        <nz-form-control [nzSpan]="12">
          <input id="metricName" type="text" nz-input formControlName="metricName">
          <!-- <nz-form-explain *ngIf="clnJobEditForm.get('metricName').dirty && clnJobEditForm.get('metricName').errors">请输入指标名称！</nz-form-explain> -->
          <nz-form-explain *ngIf="clnJobEditForm.get('metricName').dirty && clnJobEditForm.get('metricName').invalid || clnJobEditForm.get('metricName').pending ">
            <ng-container *ngIf="clnJobEditForm.get('metricName').hasError('required')">
              请输入指标名称！
            </ng-container>
            <ng-container *ngIf="clnJobEditForm.get('metricName').hasError('invalid')">
              指标名称的长度应为2-50，并且只能由小写字母、数字或符号“.”组成!
            </ng-container>
            <ng-container *ngIf="clnJobEditForm.get('metricName').pending">
              验证中...
            </ng-container>
          </nz-form-explain>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired>标签</nz-form-label>
        <nz-form-control>
          <ng-container *ngFor="let tagFilter of tagFiltersEdited, let i = index">
            <div class="input-number-container">
              <div class="sys-form">
                <span nz-checkbox [formControlName]="i + '_isGroupBy'"><label>分组</label></span>
                <nz-select style="padding-top:5px;width: 120px;margin-right: 10px;" id="select" [formControlName]="i + '_type'"
                  nzPlaceHolder="请选择">
                  <nz-option *ngFor="let option of filterTypes" [nzLabel]="option.label" [nzValue]="option.value"></nz-option>
                </nz-select>
                <input style="padding-top:5px;width: 55px;margin-right: 10px;" id="tagName" [formControlName]="i + '_name'"
                  placeHolder="标签名称" nz-input>
                <input style="padding-top:5px;width: 50px;margin-right: 10px;" id="tagValue" [formControlName]="i + '_value'"
                  placeHolder="标签值" nz-input>
                <!-- <i class="anticon anticon-close-circle-o" (click)="removeTagFilter(tagFilter,$event)"></i> -->
              </div>
            </div>
          </ng-container>
          <!-- <div class="add-action">
                        <i class="anticon anticon-plus-square" (click)="addTagFilter($event)"></i>
                        添加标签过滤
                        <nzi-help [options]="{'title': '<p>分组是否根据tagV进行分组</p><p>选择过滤器的类型</p><p>输入标签名称tagK</p><p>输入标签值tagV(表达式)</p>'}">
                        </nzi-help>
                      </div> -->
        </nz-form-control>
      </nz-form-item>

    </form>
  </ng-template>

  <ng-template #editinggModalFooter>
    <nz-spin [nzSpinning]="isButtonLoading">
    <button nz-button nzType="default" (click)="handleEditingModalCancel()">取消</button>
    <button nz-button nzType="primary" (click)="handleEditingModalOk()">确定</button>
  </nz-spin>
  </ng-template>

</nz-modal>
