@贝蒂 :unicorn: 的文档
> 官网文档地址：https://nifi.apache.org/docs.html

# **Apache NiFi概述**

## **0 目录**

* 1 什么是Apache NiFi？
* 2 NiFi的核心概念
* 3 NiFi架构
* 4 NiFi的性能期望和特性
* 5 NiFi主要功能概述

## **1 什么是Apache NiFi？**

简而言之，**NiFi**旨在自动执行不同系统之间的**数据流（Data Flow）**。

尽管 **“数据流”** 一词在多种情况下使用，但我们在这里使用它来表示 **不同系统之间的自动化和托管信息流** 。自从企业拥有多个系统以来，就一直存在这个问题：一些系统创建了数据，而某些系统使用了这些数据。

该问题和已经出现的解决方案已被广泛地讨论和阐明，目前在 **企业集成模式[eip]** 中找到了一种全面且易于使用的形式。

**数据流**的一些较难挑战包括：

* **系统故障**：网络故障、磁盘故障、软件崩溃、人为失误。

* **数据访问超出了消费能力**：有时，给定的数据源可以超过处理或交付链的某些部分-只需一个弱链接即可解决问题。

* **边界条件仅仅是建议**：导致获取数据量太大、量太小、太快、太慢、被损坏、出现错误或格式有误。

* **第一天是噪音，第二天却成为信号**：组织的优先级快速变化。启用新流程和更改现有流程必须很快。

* **系统以不同的速度发展**：给定系统使用的协议和格式可以随时更改，并且通常与周围的系统无关。数据流的存在是为了连接本质上是大规模分布的组件系统，这些组件通常是松散的或根本不是一起工作的。

* **合规性与安全性**：法律，法规和政策会发生变化。企业对企业协议会发生变化。系统到系统以及系统到用户的交互必须是安全的，可信的，负责的。

* **生产中不断改进**：通常不可能接近实验室中的复制生产环境。


多年来，数据流已成为体系结构中的必要弊端之一。

尽管有许多活跃且迅速发展的运动使数据流变得更加有趣，并且对于给定企业的成功也变得至关重要，包括：面向服务的体系结构[sooa]、API[api][api2]的兴起、物联网[iot]和大数据[bigdata]，但合规性、隐私性和安全性所必需的严格程度也在不断提高。

即使所有这些新概念都应运而生，数据流的模式和需求仍然大致相同。那么主要的区别是复杂性的范围、适应所必需的变化率以及在规模上边缘情况变得普遍。

NiFi旨在帮助解决这些现代数据流挑战。

## **2 NiFi的核心概念**

NiFi的基本设计概念与基于流程的编程[fbp]的主要思想紧密相关。以下是一些主要的NiFi概念以及它们如何映射到FBP：

NiFi条款 | FBP术语 | 描述
------- | ------- | ------
流文件 | 信息包 | FlowFile代表在系统中移动的每个对象，对于每个对象，NiFi都会跟踪键/值对属性字符串及其零个或多个字节的关联内容的映射。
FlowFile处理器 | 黑盒子 | 处理器实际上执行工作。用[eip]术语来说，处理器是在系统之间进行数据路由，转换或中介的某种组合。处理器可以访问给定FlowFile及其内容流的属性。处理器可以在给定的工作单元中对零个或多个FlowFiles进行操作，并提交该工作或回滚。
连接 | 有界缓冲区 | 连接提供了处理器之间的实际链接。这些充当队列，并允许各种进程以不同的速率进行交互。这些队列可以动态地进行优先级排序，并且可以在负载上具有上限，从而可以实现背压。
流量控制器 | 排程器 | 流控制器维护有关进程如何连接以及管理所有进程使用的线程及其分配的知识。流控制器充当代理，促进处理器之间的FlowFiles交换。
工艺组 | 子网 | 进程组是一组特定的进程及其连接，可以通过输入端口接收数据，并通过输出端口发送数据。以这种方式，过程组允许仅通过其他组件的组合来创建全新的组件。

此设计模型也类似于[seda]，提供了许多有益的结果，这些结果有助于NiFi成为构建强大且可扩展的数据流的非常有效的平台。这些好处包括：

* 非常适合视觉创建和管理处理器的有向图

* 天生是异步的，即使处理和流量波动，也可以实现很高的吞吐量和自然缓冲

* 提供高度并发的模型，而开发人员无需担心并发的典型复杂性

* 促进内聚和松耦合的组件的开发，然后可以在其他情况下重用这些组件，并开发可测试的单元

* 资源受限的连接使诸如背压和压力释放之类的关键功能非常自然和直观

* 错误处理变得像快乐路径一样自然，而不是粗粒度的包罗万象

* 数据进入和离开系统的时间点以及数据流的方式已得到很好的理解并易于跟踪

## **3 NiFi架构**

![nifi架构图](图1-nifi架构图.png)

NiFi在主机操作系统上的JVM中执行。JVM上的NiFi的主要组件如下：

### **3.1 网络服务器**

Web服务器的目的是托管NiFi基于HTTP的命令和控制API。

### **3.2 流量控制器**

流量控制器是操作的大脑。它为扩展程序提供运行所需的线程，并管理扩展程序何时接收执行资源的时间表。

### **3.3 扩展名**

其他文档中介绍了各种类型的NiFi扩展程序。这里的关键点是扩展在JVM中运行和执行。

### **3.4 FlowFile资料库**

NiFi可以在FlowFile信息库中跟踪对流中当前处于活动状态的给定FlowFile的了解状态。存储库的实现是可插入的。默认方法是位于指定磁盘分区上的持久性预写日志。

### **3.5 内容储存库**

Content Repository是给定FlowFile的实际内容字节所在的位置。存储库的实现是可插入的。默认方法是一种相当简单的机制，该机制将数据块存储在文件系统中。可以指定多个文件系统存储位置，以便使用不同的物理分区以减少任何单个卷上的争用。

### **3.6 来源库**

来源库是存储所有来源事件数据的地方。存储库构造是可插入的，默认实现是使用一个或多个物理磁盘卷。在每个位置内，事件数据都被索引并可以搜索。

NiFi还可以在集群中运行。

![nifi集群架构图](图2-nifi集群架构图.png)

从NiFi 1.0版本开始，采用了零主群集的范例。NiFi集群中的每个节点都对数据执行相同的任务，但是每个节点都对不同的数据集进行操作。Apache ZooKeeper选择一个节点作为集群协调器，并且故障转移由ZooKeeper自动处理。所有群集节点均向群集协调器报告心跳和状态信息。群集协调器负责断开和连接节点。此外，每个群集都有一个主节点，该节点也由ZooKeeper选择。作为DataFlow管理器，您可以通过任何节点的用户界面（UI）与NiFi群集进行交互。您所做的任何更改都将复制到群集中的所有节点，从而允许多个入口点。

## **4 NiFi的性能期望和特性**

NiFi旨在充分利用其所运行的基础主机系统的功能。就CPU和磁盘而言，这种资源最大化尤其强大。有关其他详细信息，请参见《管理指南》中的最佳做法和配置提示。

### **4.1 对于IO**

一个人可以期望看到的吞吐量或等待时间变化很大，这取决于系统的配置方式。鉴于大多数主要的NiFi子系统都有可插入的方法，因此性能取决于实现方式。但是，对于某些具体且广泛适用的问题，请考虑使用现成的默认实现。这些都是持久的，并保证了交付，并且使用本地磁盘来实现。因此，保守起见，假设典型服务器中的适度磁盘或RAID卷上的读取/写入速率约为每秒50 MB。然后，用于大量数据流的NiFi应该能够有效地达到每秒100 MB或更高的吞吐量。这是因为预计添加到NiFi的每个物理分区和内容存储库都将线性增长。这将在FlowFile存储库和源存储库上的某些时候成为瓶颈。我们计划提供一个基准测试和性能测试模板，以将其包含在构建中，从而使用户可以轻松地测试其系统并确定瓶颈在哪里，以及在什么时候可能成为瓶颈。该模板还应使系统管理员可以轻松进行更改并验证影响。

### **4.2 对于CPU**

流控制器充当引擎，指示何时向特定处理器分配要执行的线程。处理器被编写为在执行完任务后立即返回线程。可以为流控制器提供一个配置值，该值指示其维护的各种线程池的可用线程。使用的理想线程数取决于主机系统资源的核心数量，该系统是否也正在运行其他服务以及流中处理的性质。对于典型的IO繁重的流，合理的做法是使许多线程可用。

### **4.3 对于RAM**

NiFi驻留在JVM中，因此受限于JVM提供的内存空间。JVM垃圾回收成为限制总实际堆大小以及优化应用程序随时间运行状况的一个非常重要的因素。定期读取相同内容时，NiFi作业可能会占用大量I / O。配置足够大的磁盘以优化性能。

## **5 NiFi主要功能概述**

本部分提供了20,000英尺的NiFi基础知识视图，以便您可以了解Apache NiFi的概况以及一些最有趣的功能。关键功能类别包括流管理，易用性，安全性，可扩展的体系结构和灵活的缩放模型。

### **5.1 流管理**

#### **5.1.1 保证交货**

NiFi的核心理念是，即使规模很大，也必须保证交付。这可以通过有效使用专用的持久性预写日志和内容存储库来实现。它们的设计共同考虑到了很高的事务处理率，有效的负载分配，写时复制以及发挥了传统磁盘读/写的优势。

#### **5.1.2 带反压和泄压的数据缓冲**

NiFi支持缓冲所有排队的数据，并能够在这些队列达到指定的限制时提供反压力，或者在达到指定的使用期限（其值消失）时使数据过期。

#### **5.1.3 优先排队**

NiFi允许设置一种或多种优先级分配方案，以用于如何从队列中检索数据。默认值是最旧的优先，但是有时应该先将数据拉到最新，最大的拉或其他自定义方案中。

#### **5.1.4 特定于流的QoS（延迟v吞吐量，丢失容限等）**

在数据流的某些点上，数据是绝对关键的并且不容忍丢失。在某些情况下，有时还必须在几秒钟内将其处理并交付以具有任何价值。NiFi可以实现这些问题的细粒度流特定配置。

### **5.2 使用方便**

#### **5.2.1 视觉命令与控制**

数据流可能变得非常复杂。能够可视化这些流程并以视觉方式表达它们可以极大地帮助降低复杂性并确定需要简化的区域。NiFi不仅可以直观地建立数据流，而且可以实时建立数据流。与其说是“设计和部署”，不如说是塑造粘土。如果对数据流进行了更改，则该更改将立即生效。更改是细粒度的，并且与受影响的组件隔离。您无需停止整个流程或一组流程即可进行某些特定的修改。

#### **5.2.2 流模板**

数据流往往是高度面向模式的，尽管通常有许多不同的方法可以解决问题，但能够共享这些最佳实践对它很有帮助。模板使主题专家可以构建和发布其流程设计，并让其他人从中受益并进行协作。

#### **5.2.3 资料来源**

当对象流过系统时，即使在扇入，扇出，转换等过程中，NiFi也会自动记录，索引并提供出处数据。在支持合规性，故障排除，优化和其他方案时，此信息变得至关重要。

#### **5.2.4 恢复/记录细粒度历史记录的滚动缓冲区**

NiFi的内容存储库旨在充当历史的滚动缓冲区。数据仅在内容存储库中老化或需要空间时才被删除。这与数据源功能相结合，为在对象生命周期中甚至跨越几代的生命周期中的特定点实现单击内容，下载内容和重放提供了极为有用的基础。

### **5.3 安全**

#### **5.3.1 系统对系统**

数据流仅是安全的。数据流中每个点的NiFi都可以通过使用带有加密协议的协议（例如2路SSL）提供安全的交换。此外，NiFi使流能够加密和解密内容，并在发送方/接收方的任一侧使用共享密钥或其他机制。

#### **5.3.2 用户到系统**

NiFi启用2-Way SSL身份验证并提供可插入的授权，以便它可以在特定级别（只读，数据流管理器，管理）适当地控制用户的访问。如果用户在流中输入诸如密码之类的敏感属性，则会立即在服务器端对其进行加密，即使以其加密形式也不会再在客户端公开。

#### **5.3.3 多租户授权**

给定数据流的权限级别适用于每个组件，从而使管理员用户可以具有细粒度的访问控制级别。这意味着每个NiFi集群都能够处理一个或多个组织的需求。与隔离的拓扑相比，多租户授权为数据流管理提供了一种自助服务模型，从而使每个团队或组织都可以充分了解他们无法访问的其余流来管理流。

### **5.4 可扩展架构**

#### **5.4.1 延期**

NiFi是为扩展而构建的核心，因此，它是一个平台，数据流进程可以在该平台上以可预测和可重复的方式执行和交互。扩展点包括：处理器，控制器服务，报告任务，优先级划分程序和客户用户界面。

#### **5.4.2 类加载器隔离**

对于任何基于组件的系统，依赖关系问题都可能很快发生。NiFi通过提供自定义类加载器模型来解决此问题，确保每个扩展捆绑包都暴露于非常有限的依赖项集合中。结果，可以很少考虑扩展是否会与另一个扩展冲突。这些扩展束的概念称为“ NiFi存档”，并在《开发人员指南》中进行了详细讨论。

#### **5.4.3 站点间通信协议**

NiFi实例之间的首选通信协议是NiFi站点到站点（S2S）协议。通过S2S，可以轻松，高效，安全地将数据从一个NiFi实例传输到另一个实例。NiFi客户端库可以轻松构建并捆绑到其他应用程序或设备中，以通过S2S与NiFi通信。S2S支持基于套接字的协议和HTTP（S）协议作为基础传输协议，从而可以将代理服务器嵌入到S2S通信中。

### **5.5 弹性缩放模型**

#### **5.5.1 横向扩展（聚类）**

如上所述，NiFi旨在通过将多个节点群集在一起来进行横向扩展。如果设置了一个节点并将其配置为每秒处理数百MB，则可以将适度的群集配置为每秒处理GB。这就带来了有趣的挑战，即在NiFi和从其获取数据的系统之间进行负载平衡和故障转移。使用基于异步排队的协议（例如消息传递服务，Kafka等）可以有所帮助。使用NiFi的“站点到站点”功能也非常有效，因为它是一种协议，它允许NiFi和客户端（包括另一个NiFi集群）相互交谈，共享有关加载的信息以及交换有关特定授权的数据端口。

#### **5.5.2 放大和缩小**

NiFi还设计为以非常灵活的方式放大和缩小。从NiFi框架的角度来看，在提高吞吐量方面，可以在配置时在“调度”选项卡下增加处理器上的并发任务数。这允许更多进程同时执行，从而提供更大的吞吐量。另一方面，您可以完美地缩小NiFi的尺寸，使其适合在由于硬件资源有限而需要较小占用空间的边缘设备上运行。为了专门解决首英里数据收集挑战和边缘用例，您可以在此处找到更多详细信息：https : //cwiki.apache.org/confluence/display/NIFI/MiNiFi关于Apache NiFi的子项目MiNiFi（发音为） “最小化”，[min-uh-fahy]）。